---
import BaseLayoutSnow from "../../layouts/BaseLayoutSnow.astro";

import { getCollection } from "astro:content";
import CustomSelect from "../../components/CustomSelect.astro";
import Heading from "../../components/Heading.astro";
import ListOfPosts from "../../components/ListOfPosts.astro";
import SearchInput from "../../components/SearchInput.astro";
const allUseful = await getCollection("useful");
const lengths = allUseful.map((post) => post.body.length);

const values = ["all", "first-sem", "second-sem", "third-sem", "unbound"];
const labels = [
    "Все",
    "1 семестр",
    "2 семестр",
    "3 семестр",
    "Без привязки к курсу",
];
const options = labels.map((label, index) => ({
    label,
    value: values[index],
}));
---

<script>
    let currentCourseFilter = "all";
    let currentSearchQuery = "";

    function applyFilters() {
        const posts = document.querySelectorAll(".useful-card");

        posts.forEach((post) => {
            const course = post.getAttribute("data-course");
            const title = post.getAttribute("data-title")?.toLowerCase() || "";

            const matchesCourse =
                currentCourseFilter === "all" ||
                (currentCourseFilter === "unbound" && !course) ||
                course === currentCourseFilter;

            const matchesSearch =
                currentSearchQuery === "" ||
                title.includes(currentSearchQuery.toLowerCase());

            const isVisible = matchesCourse && matchesSearch;
            post.classList.toggle("hidden", !isVisible);
        });
    }

    document.addEventListener("selectChanged", (event) => {
        const { value: selectedValue } = (event as CustomEvent).detail;
        currentCourseFilter = selectedValue;
        applyFilters();
    });

    document.addEventListener("searchInput", (event) => {
        const { value } = (event as CustomEvent).detail;
        currentSearchQuery = value;
        applyFilters();
    });
</script>

<BaseLayoutSnow title="Полезное">
    <Heading
        title="База знаний"
        description="Здесь вы найдете подборки полезных ресурсов, статьи с теорией, раскрывающие темы курсов"
    />
    <div
        class="max-w-screen px-5 md:px-15 xl:px-0 xl:max-w-screen-lg 2xl:max-w-screen-xl mx-auto pb-30"
    >
        <ul
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 2xl:grid-cols-3 gap-5"
        >
            <div class="grid-col-span-1 mb-5">
                <CustomSelect options={options} />
            </div>
            <div class="grid-col-span-2 mt-auto mb-5">
                <SearchInput placeholder="Введите название статьи" />
            </div>
            <ListOfPosts client:load allUseful={allUseful} lengths={lengths} />
        </ul>
    </div>
</BaseLayoutSnow>
